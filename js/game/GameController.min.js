var SERVER_ERROR={ExpireError:"EXPIRE_ERROR",DataError:"DATA_ERROR",UnknownError:"0"},Application={Default:{LobbyPlayers:2,LobbyColorsNumber:7},ColorsList:"220000 00FF00 3355FF FFFF00 FF00FF FFFFFF BB0000 3E5900 333399 EE7700 888890 9900DD FFBB88 00FFBB 4A4A4F 7C4600".split(" "),MoveTimer:40,LobbyTimer:120};GameController=function(){};
GameController.Run=function(){window.PlayerModel=new modelPlayer({Player:Player,URL:{Base:BASE_URL,PlayerStatistics:"/game/playerget",PlayerGameMarker:"/game/gamemarker"},ErrorTypes:SERVER_ERROR,GameMarkerPeriod:10});window.LobbyModel=new modelLobby({PlayerID:Player.ID,URL:{Base:BASE_URL,Create:"/game/lobbycreate",Load:"/game/lobbyload",Join:"/game/lobbyjoin",Result:"/game/lobbyresult"},ErrorTypes:SERVER_ERROR});window.LobbiesCollectionModel=new modelCollection({PlayerID:Player.ID,URL:{Base:BASE_URL,
ListGet:"/game/lobbieslistget"},ErrorTypes:SERVER_ERROR,TimerPeriod:5,Callback:GameController.LobbiesListReady});window.CompetitorsModelCollection=new modelCollection({PlayerID:Player.ID,URL:{Base:BASE_URL,ListGet:"/game/availableplayersget"},ErrorTypes:SERVER_ERROR,TimerPeriod:10,Callback:GameController.CompetitorsListReady});window.Sound=new modelSound;window.LobbyTimer=new modelTimer;window.MoveTimer=new modelTimer;window.GameTimer=new modelTimer;window.GameBoard=new modelGameBoard({PlayerID:Player.ID,
URL:{Base:BASE_URL,GameStart:"/game/gamestart",GameFinish:"/game/gamefinish",GameGet:"/game/gameget",MoveSet:"/game/moveset",MoveGet:"/game/moveget",ColorMatrixGet:"/game/colormatrixget"},ErrorTypes:SERVER_ERROR,Size:{X:GameBoardSettings.SizeX,Y:GameBoardSettings.SizeY}});window.PlayerView=new viewPlayer;window.GameBoardView=new viewGameBoard({GameBoardID:"GameBoardDiv"});window.ScoreboardView=new viewScoreboard(DIALOG.LobbyView);window.GameBoardView.SizeSet(window.GameBoard.Size.X,window.GameBoard.Size.Y);
LobbyCreateDialog.ColorsNumberListSet(Application.Default.LobbyPlayers);GameController.StatisticsRefresh();GameController.Load()};GameController.Load=function(){0!=LoadGame?(window.GameBoard.GameLoad(LoadGame),GameController.GameStartReady(!0)):GameController.LobbyModeSet()};GameController.LobbyModeSet=function(){window.ScoreboardView.GamePlayersHide();window.ScoreboardView.LobbyMode();window.LobbiesCollectionModel.ListRefreshStart();window.CompetitorsModelCollection.ListRefreshStart();window.PlayerModel.GameMarkerStop()};
GameController.GameModeSet=function(){window.ScoreboardView.GamePlayersShow(window.GameBoard.PlayersList.Player);window.ScoreboardView.GameMode();window.LobbiesCollectionModel.ListRefreshStop();window.CompetitorsModelCollection.ListRefreshStop();window.PlayerModel.GameMarkerStart(GameController.CompetitorEscape)};
GameController.LobbyCreate=function(){if(""!=LobbyCreateDialog.LobbyNameGet()){var a=LobbyCreateDialog.PlayersNumberGet(),b=LobbyCreateDialog.LobbyNameGet(),c=LobbyCreateDialog.ColorsNumberGet(),d=LobbyCreateDialog.SizeGet();window.LobbyModel.Set({Name:b,SizeX:d.X,SizeY:d.Y,ColorsNumber:c,PlayersNumber:a,CreatorID:Player.ID,Active:!0});window.LobbyModel.Create(GameController.LobbyResultReady);LobbyCreateDialog.Hide();LobbyDialog.Refresh(window.LobbyModel,Player.ID);LobbyDialog.Show();window.LobbyTimer.Start({Callback:GameController.LobbyTimer,
StartValue:Application.LobbyTimer,Countdown:!0})}else LobbyCreateDialog.ErrorShow()};GameController.LobbyTimer=function(){var a=window.LobbyTimer.Get();LobbyDialog.TimerRefresh(a)};GameController.LobbyJoin=function(){LobbyDialog.ButtonDisabled("LobbyJoinButton");window.LobbyModel.Join(GameController.LobbyJoinReady)};GameController.LobbyJoinReady=function(){var a=Application.LobbyTimer-window.LobbyModel.Timer;0>a&&(a=0);window.LobbyTimer.Start({Callback:GameController.LobbyTimer,StartValue:a,Countdown:!0})};
GameController.StatisticsRefresh=function(){window.PlayerModel.StatisticsReload(GameController.StatisticsRefreshReady)};GameController.StatisticsRefreshReady=function(){window.PlayerView.StatisticsRefresh(window.PlayerModel.GetStatistics())};GameController.LobbiesListReady=function(){window.ScoreboardView.LobbiesListRefresh(window.LobbiesCollectionModel.ListGet(),"GameController.LobbySelectHandler")};
GameController.CompetitorsListReady=function(){window.ScoreboardView.CompetitorsListRefresh(window.CompetitorsModelCollection.ListGet(),"GameController.PlayerSelectHandler")};GameController.LobbySelectHandler=function(a){if(a=window.LobbiesCollectionModel.ItemGet(a))window.LobbyModel.Set(a),window.LobbyModel.Result(GameController.LobbyResultReady),LobbyDialog.Refresh(window.LobbyModel,Player.ID),LobbyDialog.Show()};
GameController.LobbyResultReady=function(a){window.LobbyModel.isActive()?window.LobbyModel.Result(GameController.LobbyResultReady):window.LobbyTimer.Stop();LobbyDialog.Refresh(window.LobbyModel,Player.ID);window.LobbyModel.isFullPlayersList()&&window.LobbyModel.isActive()&&window.LobbyModel.GetCreatorID()!=Player.ID&&window.LobbyModel.isPlayerIncluded(Player.ID)&&window.LobbyModel.ID!=window.GameBoard.LobbyID&&window.GameBoard.GameGet(window.LobbyModel.ID,GameController.GameStartReady)};
GameController.PlayerSelectHandler=function(a){var b,c=window.LobbiesCollectionModel.ListGet();Array.isArray(c)&&$.each(c,function(c,e){e.CreatorID==a&&(b=e.ID)});DIALOG.Player.Message=MessageDialog.PlayerViewGet("GameController.PlayerLobbyViewHandler",window.CompetitorsModelCollection.ItemGet(a),b);MessageDialog.Show(DIALOG.Player)};GameController.PlayerLobbyViewHandler=function(a){MessageDialog.Hide();GameController.LobbySelectHandler(a)};
GameController.GameStart=function(){window.GameBoard.GameStart(window.LobbyModel.ID,window.LobbyModel.PlayersNumber,GameController.GameStartReady)};
GameController.GameStartReady=function(a){window.LobbyTimer.Stop();window.GameTimer.Start({StartValue:window.GameBoard.GameTimer});a||LobbyDialog.Hide();GameController.GameModeSet();window.ScoreboardView.LobbiesListRefresh();window.GameBoardView.FieldSizeSet(window.GameBoard.Size.X,window.GameBoard.Size.Y);window.GameBoardView.SizeSet(window.GameBoard.Size.X,window.GameBoard.Size.Y);window.GameBoardView.GamePad(window.GameBoard.ColorsNumber,"GameController.MoveSet");window.GameBoardView.Repaint(window.GameBoard.ColorMatrix,
window.GameBoard.PlayingField,window.GameBoard.DisabledColorsGet(),window.GameBoard.ProgressByColorsListGet(),window.GameBoard.HomeCellIndex);window.ScoreboardView.PlayersScoreRefresh(window.GameBoard.PlayerGameScoreGet(),window.GameBoardView.ColorsListGet());window.ScoreboardView.GamePlayerHighlight(window.GameBoard.NextMovePlayerGet());if(window.GameBoard.NextMovePlayerGet()!=Player.ID)GameController.MoveGet();else if(a){var b=Application.MoveTimer-window.GameBoard.MoveTimer;0>b&&(b=0);window.MoveTimer.Start({Callback:GameController.MoveTimer,
StartValue:b,Countdown:!0})}else window.MoveTimer.Start({Callback:GameController.MoveTimer,StartValue:Application.MoveTimer,Countdown:!0});a?MessageDialog.Show(DIALOG.GameRecovery):MessageDialog.Show(DIALOG.GameStart)};
GameController.GameFinish=function(){var a=window.GameBoard.WinnerGet();a.ID==Player.ID?(MessageDialog.Show(DIALOG.Victory,{YesButton:GameController.LobbyModeSet}),window.Sound.Play("Victory")):(DIALOG.Defeat.Message=DIALOG.Defeat.Message.replace("{COMPETITOR_NAME}","\u00ab"+a.Name+"\u00bb"),MessageDialog.Show(DIALOG.Defeat,{YesButton:GameController.LobbyModeSet}));window.GameBoard.GameFinish(GameController.GameFinishReady);window.GameTimer.Stop()};GameController.GameFinishReady=function(){GameController.StatisticsRefresh()};
GameController.CompetitorEscape=function(){window.GameBoard.GameID&&(MessageDialog.Show(DIALOG.CompetitorEscape,{YesButton:GameController.LobbyModeSet}),window.GameBoard.GameReset())};
GameController.MoveSet=function(a){window.GameBoard.MoveSet(a,GameController.MoveSetReady)&&(window.MoveTimer.Stop(),window.GameBoardView.Repaint(window.GameBoard.ColorMatrix,window.GameBoard.PlayingField,window.GameBoard.DisabledColorsGet(),window.GameBoard.ProgressByColorsListGet(),window.GameBoard.HomeCellIndex),window.ScoreboardView.PlayersScoreRefresh(window.GameBoard.PlayerGameScoreGet(),window.GameBoardView.ColorsListGet()),window.ScoreboardView.GamePlayerHighlight(window.GameBoard.NextMovePlayerGet()),
window.Sound.Play("Move"))};GameController.MoveSetReady=function(){window.GameBoard.GameStatusGet()?window.GameBoard.NextMovePlayerGet()!=Player.ID&&GameController.MoveGet():GameController.GameFinish()};GameController.MoveTimer=function(){var a=window.MoveTimer.Get();window.ScoreboardView.PlayerTimerRefresh(window.GameBoard.NextMovePlayerGet(),a);a||GameController.MoveSet(window.GameBoard.CorrectMoveGet())};
GameController.MoveGet=function(){window.GameBoard.MoveGet(window.GameBoard.NextMovePlayerGet(),GameController.MoveGetReady)};
GameController.MoveGetReady=function(){window.GameBoardView.Repaint(window.GameBoard.ColorMatrix,window.GameBoard.PlayingField,window.GameBoard.DisabledColorsGet(),window.GameBoard.ProgressByColorsListGet(),window.GameBoard.HomeCellIndex);window.ScoreboardView.PlayersScoreRefresh(window.GameBoard.PlayerGameScoreGet(),window.GameBoardView.ColorsListGet());window.ScoreboardView.GamePlayerHighlight(window.GameBoard.NextMovePlayerGet());window.Sound.Play("Move");window.GameBoard.GameStatusGet()?window.GameBoard.NextMovePlayerGet()!=
Player.ID?GameController.MoveGet():window.MoveTimer.Start({Callback:GameController.MoveTimer,StartValue:Application.MoveTimer,Countdown:!0}):GameController.GameFinish()};GameController.AdjacentCellsHighlightOn=function(a){-1==window.GameBoard.DisabledColorsGet().indexOf(a)&&(a=window.GameBoard.AdjacentCellsListGet(Player.ID,a),window.GameBoardView.CellHighlightShow(a))};GameController.AdjacentCellsHighlightOff=function(){window.GameBoardView.CellHighlightHide()};$(window).load(function(){GameController.Run()});
$(document).ready(function(){$("#LobbyCreate, #LobbyCreate-xs").click(function(){LobbyCreateDialog.Show()});$("#LobbySaveButton").click(GameController.LobbyCreate);$("#LobbyJoinButton").click(GameController.LobbyJoin);$("#GameStartButton").click(GameController.GameStart);$("#Button-Sound").click(function(){window.Sound.Toggle();window.ScoreboardView.SoundIconRefresh(window.Sound.Mute)});$("#Button-Help").click(function(){MessageDialog.Show(DIALOG.GameHelp)});$(document).on("mouseover",".GameButton",
function(a){a=a.target.id;a=a.substring(5,a.length);a=parseInt(a,10);"number"===typeof a&&GameController.AdjacentCellsHighlightOn(a)}).on("mouseleave",".GameButton",function(){GameController.AdjacentCellsHighlightOff()})});$(window).resize(function(){window.GameBoardView.SizeSet(window.GameBoard.Size.X,window.GameBoard.Size.Y)});
